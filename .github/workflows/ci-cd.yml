name: CI/CD Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: juniqu-e/guestbook-cicd

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for backend
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix=commit-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Extract metadata for frontend
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix=commit-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}

    # ğŸ”¥ í•µì‹¬ ìˆ˜ì •: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œì— í™˜ê²½ë³€ìˆ˜ ì¶”ê°€
    - name: Build and push Frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        build-args: |
          VITE_API_BASE_URL=https://t1324.p.ssafy.io/api
          VITE_APP_TITLE=ë°©ëª…ë¡
          VITE_APP_VERSION=1.0.0
          VITE_ENVIRONMENT=production
          VITE_API_TIMEOUT=30000

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Test SSH connection
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "âœ… SSH ì—°ê²° ì„±ê³µ!"
          echo "í˜„ì¬ ì‚¬ìš©ì: $(whoami)"
          echo "Docker ë²„ì „: $(docker --version)"
          echo "Docker Compose í™•ì¸: $(docker compose version || docker-compose --version)"

    - name: Copy deployment files to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 300s
        script: |
          # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/guestbook
          cd ~/guestbook
          
          # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
          if [ -f docker-compose.prod.yml ]; then
            cp docker-compose.prod.yml docker-compose.prod.yml.backup.$(date +%Y%m%d_%H%M%S)
          fi
          if [ -f deploy.sh ]; then
            cp deploy.sh deploy.sh.backup.$(date +%Y%m%d_%H%M%S)
          fi

    - name: Upload docker-compose.prod.yml content
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 60s
        script: |
          cd ~/guestbook
          cat > docker-compose.prod.yml << 'EOF'
          services:
            backend:
              image: ghcr.io/juniqu-e/guestbook-cicd/backend:${IMAGE_TAG:-latest}
              container_name: guestbook-backend
              ports:
                - "8080:8080"
              environment:
                - SPRING_PROFILES_ACTIVE=docker
                - JPA_SHOW_SQL=false
                - LOG_LEVEL_APP=INFO
                - LOG_LEVEL_WEB=WARN
                - H2_CONSOLE_ENABLED=false
              restart: unless-stopped
              networks:
                - guestbook-network

            frontend:
              image: ghcr.io/juniqu-e/guestbook-cicd/frontend:${IMAGE_TAG:-latest}
              container_name: guestbook-frontend
              ports:
                - "3000:80"
              depends_on:
                - backend
              restart: unless-stopped
              networks:
                - guestbook-network

          networks:
            guestbook-network:
              driver: bridge
          EOF

    - name: Upload deploy.sh script
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 60s
        script: |
          cd ~/guestbook
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ ë°©ëª…ë¡ ë°°í¬ ì‹œì‘... ($(date))"
          
          # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ í™•ì¸
          if [ -z "$IMAGE_TAG" ]; then
            echo "âŒ IMAGE_TAG í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ GITHUB_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "ğŸ“¦ ë°°í¬í•  ì´ë¯¸ì§€ íƒœê·¸: $IMAGE_TAG"
          
          # Docker Compose ëª…ë ¹ì–´ í™•ì¸
          if command -v docker-compose &> /dev/null; then
            COMPOSE_CMD="docker-compose"
          elif docker compose version &> /dev/null; then
            COMPOSE_CMD="docker compose"
          else
            echo "âŒ Docker Composeë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… ì‚¬ìš©í•  Docker Compose: $COMPOSE_CMD"
          
          # GitHub Container Registry ë¡œê·¸ì¸
          echo "ğŸ” Container Registry ë¡œê·¸ì¸ ì¤‘..."
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
          
          # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì •ë¦¬
          echo "ğŸ›‘ ê¸°ì¡´ ì„œë¹„ìŠ¤ ì •ë¦¬ ì¤‘..."
          timeout 60s $COMPOSE_CMD -f docker-compose.prod.yml down --remove-orphans || true
          
          # ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          echo "ğŸ“¥ ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          export IMAGE_TAG=$IMAGE_TAG
          timeout 300s $COMPOSE_CMD -f docker-compose.prod.yml pull
          
          # ìƒˆ ì„œë¹„ìŠ¤ ì‹œì‘
          echo "ğŸš€ ìƒˆ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          timeout 180s $COMPOSE_CMD -f docker-compose.prod.yml up -d
          
          if docker ps --format "table {{.Names}}\t{{.Status}}" | grep -q "guestbook"; then
            echo "âœ… ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
            $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=20
            exit 1
          fi
          
          # ğŸ” í™˜ê²½ë³€ìˆ˜ ì ìš© í™•ì¸
          echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ API URL í™•ì¸:"
          docker exec guestbook-frontend find /usr/share/nginx/html -name "*.js" | head -1 | xargs docker exec guestbook-frontend grep -o 'https://t1324\.p\.ssafy\.io\|localhost:8080' | head -3
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo "ğŸ“‹ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤:"
          $COMPOSE_CMD -f docker-compose.prod.yml ps
          
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ Frontend: http://$(curl -s ifconfig.me):3000"
          echo "ğŸ”§ Backend: http://$(curl -s ifconfig.me):8080"
          EOF
          
          # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x deploy.sh

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 600s
        command_timeout: 900s
        script: |
          cd ~/guestbook
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export IMAGE_TAG="latest"
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          export GITHUB_ACTOR="${{ github.actor }}"
          
          # ë°°í¬ ì‹¤í–‰
          ./deploy.sh